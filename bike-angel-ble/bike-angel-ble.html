<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bike Angel BLE</title>
  <link rel="shortcut icon" href="./img/icon_bike_angel.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <div class="container d-flex justify-content-center align-items-top">
    <div class="card col-6" style="width: 18rem">
      <img src="./img/instructables.png" class="card-img-top" alt="Bike Angel BLE" />
      <div class="card-body">
        <h5 class="card-title">DIY Arduino</h5>
        <p class="card-text">
          Follow the instructions to build your own Arduino bike alarm
        </p>
        <a href="https://www.instructables.com/Arduino-Bike-Alarm-Meets-Android-App-Via-Bluetooth/"
          class="btn btn-primary">Instructables</a>
      </div>
    </div>

    <div class="card col-6" style="width: 18rem">
      <img src="./img/cover-square.png" class="card-img-top" alt="Bike Angel BLE" />
      <div class="card-body">
        <h5 class="card-title">Bike Angel BLE</h5>
        <p class="card-text">Get your companion Android app</p>
        <a href="https://play.google.com/store/apps/details?id=com.restlesspedals.bikeangel" class=""><img
            src="./img/GetItOnGooglePlay_Badge_Web_color_English.png" alt="getitongoogleplay" class="googleplay" /></a>
      </div>
    </div>
  </div>

  <div class="container px-4 py-5" id="featured-3">
    <h2 class="pb-2 border-bottom">Features</h2>
    <div class="row g-4 py-5 row-cols-1 row-cols-lg-3">
      <div class="feature col">
        <div
          class="feature-icon d-inline-flex align-items-center justify-content-center text-bg-primary bg-gradient fs-2 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
            class="bi bi-battery-charging" viewBox="0 0 16 16">
            <path
              d="M9.585 2.568a.5.5 0 0 1 .226.58L8.677 6.832h1.99a.5.5 0 0 1 .364.843l-5.334 5.667a.5.5 0 0 1-.842-.49L5.99 9.167H4a.5.5 0 0 1-.364-.843l5.333-5.667a.5.5 0 0 1 .616-.09z" />
            <path d="M2 4h4.332l-.94 1H2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h2.38l-.308 1H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2" />
            <path
              d="M2 6h2.45L2.908 7.639A1.5 1.5 0 0 0 3.313 10H2zm8.595-2-.308 1H12a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H9.276l-.942 1H12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z" />
            <path
              d="M12 10h-1.783l1.542-1.639q.146-.156.241-.34zm0-3.354V6h-.646a1.5 1.5 0 0 1 .646.646M16 8a1.5 1.5 0 0 1-1.5 1.5v-3A1.5 1.5 0 0 1 16 8" />
          </svg>
        </div>
        <h3 class="fs-2 text-body-emphasis">Power efficient</h3>
        <p>The Arduino code is optimized for power efficiency without compromising the alarm's performance. The alarm
          remains highly responsive and sends instant notifications.</p>
        <a href="./bike-angel-ble/bike-angel-ble.html" class="icon-link">
          Learn more
          <svg class="bi">
            <use xlink:href="#chevron-right"></use>
          </svg>
        </a>
      </div>
      <div class="feature col">
        <div
          class="feature-icon d-inline-flex align-items-center justify-content-center text-bg-primary bg-gradient fs-2 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-boxes"
            viewBox="0 0 16 16">
            <path
              d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2.001a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434zM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567zM7.5 9.933l-2.75 1.571v3.134l2.75-1.571zm1 3.134 2.75 1.571v-3.134L8.5 9.933zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567zm2.242-2.433V3.504L8.5 5.076V8.21zM7.5 8.21V5.076L4.75 3.504v3.134zM5.258 2.643 8 4.21l2.742-1.567L8 1.076zM15 9.933l-2.75 1.571v3.134L15 13.067zM3.75 14.638v-3.134L1 9.933v3.134z" />
          </svg>
        </div>
        <h3 class="fs-2 text-body-emphasis">Customizable</h3>
        <p>Customize Arduino settings like sensitivity and alarm duration directly in the app. Choose your preferred
          alarm sound and mute the alarm from either your phone or the Arduino device.</p>
        <a href="./bike-angel-ble/bike-angel-ble.html" class="icon-link">
          Learn more
          <svg class="bi">
            <use xlink:href="#chevron-right"></use>
          </svg>
        </a>
      </div>
      <div class="feature col">
        <div
          class="feature-icon d-inline-flex align-items-center justify-content-center text-bg-primary bg-gradient fs-2 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-bluetooth"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="m8.543 3.948 1.316 1.316L8.543 6.58zm0 8.104 1.316-1.316L8.543 9.42zm-1.41-4.043L4.275 5.133l.827-.827L7.377 6.58V1.128l4.137 4.136L8.787 8.01l2.745 2.745-4.136 4.137V9.42l-2.294 2.274-.827-.827zM7.903 16c3.498 0 5.904-1.655 5.904-8.01 0-6.335-2.406-7.99-5.903-7.99S2 1.655 2 8.01C2 14.344 4.407 16 7.904 16Z" />
          </svg>
        </div>
        <h3 class="fs-2 text-body-emphasis">Remote control</h3>
        <p>Manage the Arduino device from your Android phone: start or stop alarm detection, adjust settings, and
          receive notifications for alarms or low battery alerts.</p>
        <a href="./bike-angel-ble/bike-angel-ble.html" class="icon-link">
          Learn more
          <svg class="bi">
            <use xlink:href="#chevron-right"></use>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Components</h2>
    <ul class="list-group">
      <li class="list-group-item"><a href="https://www.aliexpress.com/item/1005006349109886.html">Arduino Pro Mini
          3.3V</a></li>
      <li class="list-group-item"><a href="https://www.aliexpress.com/item/32817938949.html">HM-10 BLE 4.0 Bluetooth
          module or compatible</a></li>
      <li class="list-group-item">Buzzer</li>
      <li class="list-group-item"><a href="https://www.aliexpress.com/item/1005005859152818.html">SW-420 ball switch</a>
      </li>
      <li class="list-group-item"><a href="https://www.aliexpress.com/item/1005001276119180.html">Mini DC-DC boost
          converter to 5V or similar</a></li>
      <li class="list-group-item">resistors (1x~220立 for buzzer, 1x~10k立 and 2xlarge (100k立 - 1M立) for reading the
        battery level)</li>
      <li class="list-group-item">3.7V battery</li>
    </ul>
  </div>

  <div class="container">
    <h2>Wiring</h2>
    <img src="./img/wiring.png" class="img-fluid" alt="wiring">
  </div>

  <div class="container">
    <h2>Code</h2>
    <pre class="bg-light p-3 rounded border">
      <code>
        #include &lt;SoftwareSerial.h&gt;
        #include &lt;LowPower.h&gt;
        #include &lt;EEPROM.h&gt;
  
        #define BLE_TX 3 // HM-10 TX pin connected to Arduino pin 3
        #define BLE_RX 9 // HM-10 RX pin connected to Arduino interrupt pin 9
        #define BUZZER_PIN 6
        #define SENSOR_PIN 2 // ball sensor on interrupt pin
        #define BATTERY_PIN A0 // measure battery level
        
        // customize low, med and high sensibility levels
        #define LOW_SENS_FACTOR 5
        #define MED_SENS_FACTOR 3
        #define HIGH_SENS_FACTOR 1
        
        // For a 3.7V battery, 3.2V would be low voltage. Since the voltage divider
        // has equal resistors, the voltage read is half, so 1.6V
        #define LOW_BATTERY_THRESHOLD 1.76 // for the 3.3V model
        
        // ingress commands
        #define CMD_START 0xFF // start movement detection
        #define CMD_STOP 0xFE // stop movement detection
        #define CMD_PING 0xFC // test connection
        #define CMD_BEEP 0xFB // ring alarm
        #define CMD_LOW 0xED // sensitivity
        #define CMD_MED 0xEE // sensitivity
        #define CMD_HIGH 0xEF // sensitivity
        #define CMD_SAVE_CONFIG 0xAA // saves config variables (sensibility, duration, etc)
        #define CMD_MUTE_ON 0xAB // mute the alarm
        #define CMD_MUTE_OFF 0xAC
        #define CMD_READ_CONFIG 0xAD // send to android app the current configuration (sensibility, duration, etc)
        #define CMD_BEACON_ON 0xEB // send beacon at regular intervals
        #define CMD_BEACON_OFF 0xEC
        #define CMD_DURATION 0xB8 //0xB8 - 0xBF alarm duration
        
        // egress commands
        #define CMD_PONG 0xFD // response to CMD_PING
        #define CMD_BEACON 0xEA // send beacon signal to let the android app know the system is functional
        #define CMD_ALARM 0xFA
        #define CMD_LOW_BATTERY 0xDC
        // Also, ACK signal for ingress commands, as CMD - 8
        
        // Addresses in EEPROM to store variables
        #define ADDR_BEACON 0
        #define ADDR_MUTED 1
        #define ADDR_SENSITIVITY 2
        #define ADDR_DURATION 3
        
        // write buffer
        String buffer;
        
        // config vars
        boolean sendBeacon = false;
        boolean isDetectionActive = true;
        boolean isMuted = false;
        unsigned short int alarmDuration = 1500;
        unsigned char sensitivity = 1;
        
        // interrupt flags
        volatile bool alarmInterrupt = false;
        volatile bool rxInterrupt = false;
        
        // ball sensor is very sensitive, on a slight move it could trigger tens of times
        // The number of interrupts is directly linked to the alarm sensibility level
        volatile unsigned long ballMovement = 0; 
        
        SoftwareSerial BLE(BLE_TX, BLE_RX);
        
        // interrupt ISR
        void wakeUpOnRX() {
          rxInterrupt = true;
        }
        
        // interrupt ISR
        void detectAlarm() {
          ballMovement += 1;
          alarmInterrupt = true;
        }
        
        void setup() {
          pinMode(LED_BUILTIN, OUTPUT);
        
          pinMode(SENSOR_PIN, INPUT_PULLUP); // Watchdog pin to wake up on movement
          pinMode(BLE_TX, INPUT_PULLUP); // Watchdog pin to wake up on BLE comms
          pinMode(BATTERY_PIN, INPUT); // battery level
          pinMode(BLE_RX, OUTPUT); // BLE comms
          pinMode(BUZZER_PIN, OUTPUT); // piezzo buzzer
          digitalWrite(BUZZER_PIN, HIGH);
          
          attachInterrupt(digitalPinToInterrupt(SENSOR_PIN), detectAlarm, FALLING);
          attachInterrupt(digitalPinToInterrupt(BLE_TX), wakeUpOnRX, FALLING);
        
          buffer = "";
          Serial.begin(9600); // Initialize Serial Monitor
          BLE.begin(9600); // Initialize BLE communication
        
          // load config vars
          EEPROM.get(ADDR_BEACON, sendBeacon);
          EEPROM.get(ADDR_MUTED, isMuted);
          EEPROM.get(ADDR_SENSITIVITY, sensitivity);
          EEPROM.get(ADDR_DURATION, alarmDuration);
        
          validateEEPROMvars(); // if values from EEPROM are invalid, init with default
        
          Serial.println("Starting..");
          delay(200);
        }
        
        void loop() {
          // read battery level
          int adcValue = analogRead(BATTERY_PIN);
          float voltage = (adcValue / 1023.0) * 3.3; // for 3.3V arduino
          Serial.print(voltage);
          Serial.println(" V");
          delay(100);
        
          // read for incoming commands before sending signals back (low battery, beacon, alarm)
          if (BLE.available() || rxInterrupt) {
            readIncoming(); 
            delay(100); 
            rxInterrupt = false;
          }
          
          // send low battery signal
          if (voltage &lt; LOW_BATTERY_THRESHOLD){
            Serial.println("Low battery");
            buffer += (char)CMD_LOW_BATTERY;
          }
        
          // detect alarms
          if (alarmInterrupt && isDetectionActive) {
        //    Serial.println(ballMovement);
            // sensitivity * 5 determines how sensitive the movement detection is
            if (sensitivity * 5 &lt; ballMovement) {
        
              Serial.println("ALARM!");
              buffer += (char)CMD_ALARM;
              beep();
            }
            ballMovement = 0;
            alarmInterrupt = false;
          }
        
          if (!isDetectionActive)
            ballMovement = 0;
        
          if (sendBeacon){
            buffer += (char)CMD_BEACON;
          }
        
          sendBuffer();
          
          // low power sleep saves battery
          LowPower.powerDown(SLEEP_8S, ADC_OFF, BOD_OFF); 
        }
        
        void readIncoming() {
          delay(500); // Allow buffer to fill, if BLE data is incoming
          while (BLE.available()) {
            byte command = BLE.read();
            byte response = runCommand(command);
        
            // send ACK signal back to the android app
            if (response != 0x00) {
              // confirm on Arduino side (blink builtin led)
              digitalWrite(LED_BUILTIN, HIGH);  
              delay(400);                       
              digitalWrite(LED_BUILTIN, LOW);    
        
              buffer += (char)response;
              Serial.print("CMD: "); Serial.println(command, HEX);
            }
          }
        }
        
        // ring alarm
        void beep() {
          if (isMuted) {
            delay(alarmDuration);
            return;
          }
          digitalWrite(BUZZER_PIN, LOW);
          delay(alarmDuration);
          digitalWrite(BUZZER_PIN, HIGH);
        }
        
        // if values read from EEPROM are not valid, initialize with default
        void validateEEPROMvars() {
          bool initVars = false;
          if (sendBeacon != 0 && sendBeacon != 1) initVars = true;
          if (isMuted != 0 && isMuted != 1) initVars = true;
          if (sensitivity > 255) initVars = true;
          if (alarmDuration % 250 != 0) initVars = true;
        
          if (initVars) {
            sendBeacon = false;
            isMuted = false;
            sensitivity = 1;
            alarmDuration = 1500;
            runSaveConfig();
          }
        }
        
        void runSaveConfig() {
          EEPROM.put(ADDR_BEACON, sendBeacon);
          EEPROM.put(ADDR_MUTED, isMuted);
          EEPROM.put(ADDR_SENSITIVITY, sensitivity);
          EEPROM.put(ADDR_DURATION, alarmDuration);
          Serial.println("Saved Config");
        }
        
        byte getCurrentConfig() {
          unsigned short int sensitivityEncoded;
          if (sensitivity == LOW_SENS_FACTOR) sensitivityEncoded = 0;
          if (sensitivity == MED_SENS_FACTOR) sensitivityEncoded = 1;
          if (sensitivity == HIGH_SENS_FACTOR) sensitivityEncoded = 2;
          
          unsigned short int durationEncoded = (alarmDuration / 250 - 1) % 8; // ensure durationEncoded takes only 3 bits
          
          byte encodedByte1 = (5 &lt;&lt; 4) | (isMuted &lt;&lt; 3) | durationEncoded;
          byte encodedByte2 = (6 &lt;&lt; 4) | (isDetectionActive &lt;&lt; 3) | (sendBeacon &lt;&lt; 2) | sensitivityEncoded;
        
          buffer += (char)encodedByte1;
          buffer += (char)encodedByte2;
        }
        
        void sendBuffer() {
            if (buffer.length() > 0) {
                Serial.println(buffer.length());
                BLE.write(buffer.c_str(), buffer.length());
                buffer = ""; // Clear buffer after sending
                BLE.flush();
                delay(300);
            }
        }
        
        byte runCommand(byte cmd) {
        //  Serial.print(" "); Serial.println(cmd, HEX);
          byte reponse = cmd - 8;
          if (cmd >= CMD_DURATION && cmd &lt;= CMD_DURATION + 7) {
            alarmDuration = (cmd - CMD_DURATION + 1) * 250;
            return reponse;
          }
          
          switch (cmd) {
            case CMD_START:       isDetectionActive = true;           break;
            case CMD_STOP:        isDetectionActive = false;          break;
            case CMD_LOW:         sensitivity = LOW_SENS_FACTOR;      break;
            case CMD_MED:         sensitivity = MED_SENS_FACTOR;      break;
            case CMD_HIGH:        sensitivity = HIGH_SENS_FACTOR;     break;
            case CMD_PING:        buffer += (char)CMD_PONG;           break;
            case CMD_SAVE_CONFIG: runSaveConfig();                    break;
            case CMD_READ_CONFIG: getCurrentConfig();                 break;
            case CMD_BEEP:        beep();                             break;
            case CMD_MUTE_ON:     isMuted = true;                     break;
            case CMD_MUTE_OFF:    isMuted = false;                    break;
            case CMD_BEACON_ON:   sendBeacon = true;                  break;
            case CMD_BEACON_OFF:  sendBeacon = false;                 break;
            
            default: reponse = 0x00; // No response for unknown commands
          }
        
          return reponse;
        }
      </code>
    </pre>
  </div>

  <div class="social-links">
    <a href="https://twitter.com/RestlessPedals" alt="twitter link" target="_blank">
      <i class="fab fa-twitter social-icon"></i>
    </a>
    <a href="https://www.instagram.com/restlesspedals" alt="instagram link" target="_blank">
      <i class="fab fa-instagram social-icon"></i>
    </a>
    <a href="https://pinterest.com/restlesspedals/" alt="pinterest link" target="_blank">
      <i class="fab fa-pinterest social-icon"></i>
    </a>
    <a href="https://restlesspedals.eu/" alt="blog link" target="_blank">
      <i class="fab fa-blogger social-icon"></i>
    </a>
    <a href="https://www.polarsteps.com/RestlessPedals" alt="polarsteps link" target="_blank">
      <img src="./bargain/img/Polarsteps.svg" alt="Polarsteps" class="social-icon">
    </a>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</html>